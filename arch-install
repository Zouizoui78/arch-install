#!/bin/bash

set -eou pipefail
. chrooted/lib

echo "WARNING : This script does not care about your data.
New partitions will be created and the existing data will be permanently lost.
Press ctrl+c right now if this is not ok.
Which disk to install on ?"
read DISK

# Simulates manual inputs to fdisk
# The sed command strips the comment
# Blank lines use the default option
# Taken from https://superuser.com/a/984637
# Here we setup partitions as per
# https://wiki.archlinux.org/title/Dm-crypt/Encrypting_an_entire_system#LUKS_on_a_partition_with_TPM2_and_Secure_Boot
sed -e 's/\s*\([\+0-9a-zA-Z]*\).*/\1/' << EOF | fdisk "$DISK"
    g # new GPT partition table
    n # new partition
    # default - partition number #1
    # default - first sector
    +1G # efi partition size
    t # change partition type
    1 # select "EFI system" partition type
    n # new partition
    # default - partition number #2
    # default - first sector
    # default - last sector
    t # change partition type
    # default - partition number #2
    23 # select "Linux root (x86-64)" partition type
    p # print the in-memory partition table
    w # write the partition table
    q # and we're done
EOF

EFI_PART_PATH=$(get_disk_partition_path "$DISK" 1)
LUKS_PART_PATH=$(get_disk_partition_path "$DISK" 2)

# This passphrase will be removed after first boot when enrolling TPM
echo "passphrase" | cryptsetup luksFormat $LUKS_PART_PATH -
echo "passphrase" | cryptsetup open $LUKS_PART_PATH root -d -

mkfs.ext4 /dev/mapper/root
mount /dev/mapper/root /mnt

mkfs.fat -F 32 "$EFI_PART_PATH"
mount --mkdir "$EFI_PART_PATH" /mnt/efi

pacstrap -K /mnt base linux linux-firmware cronie sbctl sudo

cp -r chrooted /mnt/arch-install
chmod 700 /mnt/arch-install

arch-chroot /mnt bash -c /arch-install/chrooted-arch-install

echo "Done !
Don't forget to store /arch-install/luks-recovery-key.txt somewhere safe.
You can reboot and use the system now."
